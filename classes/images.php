<?php class images extends masterclass{	function extend(){ 		$this->sql['items'] .= ' ORDER BY id DESC';			if($this->do == 'view') $this->ajax = TRUE;	}			function items(){			$this->updatetags();		$this->params['tagcloud'] = unserialize(G('images_tagcloud'));		$tag = @$this->path[3];		$this->sql['count'] = "SELECT count(i.id) FROM images i";		$this->sql['items'] = "SELECT i.* FROM images i ";				if($tag!=''){			$this->sql['items'] .= "  JOIN tags_images t ON t.img_id = i.id AND t.tag='$tag'"; 			$this->sql['count'] .= "  JOIN tags_images t ON t.img_id = i.id AND t.tag='$tag'";		}		$this->sql['items'] .=" GROUP BY i.id ORDER BY `date` DESC";					$this->pages = ceil(DBfield($this->sql['count'].$cc) / $this->perpage);				if($this->page>0) $this->page--;		$cc .=$this->orderby." LIMIT ".$this->page*$this->perpage.",".$this->perpage; 		return DBall($this->sql['items'].$cc);	}		function updatetags() {		$tagSQL = "SELECT tag, COUNT( t.tag ) AS total		FROM tags_images t		JOIN images i ON t.img_id = i.id		GROUP BY t.tag		ORDER By total DESC";		$tagcloud = serialize(DBall($tagSQL));		$sql = "DELETE from globals WHERE `name`='images_tagcloud'"; DBquery($sql);		$sql = "INSERT INTO globals SET `value`='$tagcloud', `name`='images_tagcloud'"; DBquery($sql);		getGlobals();	}		function save(){		$url = parseString($this->post['form']['url']);		$check = DBcell("SELECT id FROM images WHERE url LIKE '%$url'"); //die($check);		if($check < 1 || $this->id > 0) { //if link don't exist or link exist, but we don't add new but update old, we save			$tags = $this->post['form']['tags']; 			parent :: save();						if(!$check) {				$img = getimagesize($url);				file_put_contents('./up/img/'.$this->id,file_get_contents($url));				createthumb('./up/img/'.$this->id,'./up/thumb/'.$this->id,150,150,$img['mime']);			}						$taglist = split(',',$tags);			$sql = "DELETE FROM tags_images WHERE img_id='{$this->id}'";			DBquery($sql);			if($taglist[0] != ''){				foreach ($taglist as $tag){					$tag = trim($tag);						$sql = "INSERT INTO	tags_images SET img_id='{$this->id}', tag='$tag'";					DBquery($sql); 				}			}			$this->updatetags();		} else { //otherwise return id of image - that's for api			$this->id = $check;		}			}		function del(){		DBquery("DELETE FROM tags_images WHERE img_id={$this->id}");		parent :: del();		$this->updatetags();	}	} ?>