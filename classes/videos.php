<?php class videos extends masterclass{	function extend(){ 					$this->sql['items'] .= ' ORDER BY id DESC';		}			function items(){			//$this->updatetags();		$this->params['tagcloud'] = unserialize(G('videos_tagcloud'));		$tag = @$this->path[3];		$this->sql['count'] = "SELECT count(v.id) FROM videos v";		$this->sql['items'] = "SELECT v.* FROM videos v ";				if($tag!=''){			$this->sql['items'] .= "  JOIN tags_videos t ON t.video_id = v.id AND t.tag='$tag'"; 			$this->sql['count'] .= "  JOIN tags_videos t ON t.video_id = v.id AND t.tag='$tag'";		}		$this->sql['items'] .=" GROUP BY v.id ORDER BY `date` DESC";					$this->pages = ceil(DBfield($this->sql['count'].$cc) / $this->perpage);				if($this->page>0) $this->page--;		$cc .=$this->orderby." LIMIT ".$this->page*$this->perpage.",".$this->perpage; 		return DBall($this->sql['items'].$cc);	}		function updatetags() {		$tagSQL = "SELECT tag, COUNT( t.tag ) AS total		FROM tags_videos t		JOIN videos v ON t.video_id = v.id		GROUP BY t.tag		ORDER By total DESC";		$tagcloud = serialize(DBall($tagSQL));		$sql = "DELETE from globals WHERE `name`='videos_tagcloud'"; DBquery($sql);		$sql = "INSERT INTO globals SET `value`='$tagcloud', `name`='videos_tagcloud'"; DBquery($sql);		getGlobals();	}			function save(){		$url = $this->post['form']['url'];		$host = $this->post['host'];		switch($host) {			case 'youtube.com':				$this->post['form']['url'] = $url = substr($url,0,strpos($url, '?')) . '?autoplay=1';			break;		}		$url = parseString($url);		$sql = "SELECT id FROM videos WHERE url LIKE '%$url%'";	//echo $sql;		$check = DBcell($sql); //die($check);				if($check < 1 || $this->id > 0) { //if link don't exist or link exist, but we don't add new but update old, we save			$tags = $this->post['form']['tags']; //die(inspect($tags));			parent :: save();						if(!$check) { /*creating thumb for video */				$url = $this->post['img'];				$img = getimagesize($url);				$thumb = './up/videothumb/' . $this->id;				file_put_contents($thumb, file_get_contents($url));				//createthumb('./up/tmp', $thumb, 300, 200, $img['mime']);			}						$taglist = split(',',$tags);			$sql = "DELETE FROM tags_videos WHERE video_id='{$this->id}'";			DBquery($sql);// echo $sql;			if($taglist[0] != ''){				foreach ($taglist as $tag){					$tag = trim($tag);						$sql = "INSERT INTO	tags_videos SET video_id='{$this->id}', tag='$tag'";					DBquery($sql); //echo $sql;				}			}			$this->updatetags();		} else { //otherwise return id of image - that's for api			$this->id = $check;		}			}		function del(){		DBquery("DELETE FROM tags_videos WHERE video_id={$this->id}");		parent :: del();		$this->updatetags();	}	} ?>